"use strict";var QuicksliceClient=(()=>{var v=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var F=(t,e)=>{for(var r in e)v(t,r,{get:e[r],enumerable:!0})},Y=(t,e,r,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of W(e))!M.call(t,n)&&n!==r&&v(t,n,{get:()=>e[n],enumerable:!(i=G(e,n))||i.enumerable});return t};var X=t=>Y(v({},"__esModule",{value:!0}),t);var oe={};F(oe,{LoginRequiredError:()=>x,NetworkError:()=>b,OAuthError:()=>k,QuicksliceClient:()=>u,QuicksliceError:()=>g,createQuicksliceClient:()=>ne});function C(t){return{clientId:`quickslice_${t}_client_id`,codeVerifier:`quickslice_${t}_code_verifier`,oauthState:`quickslice_${t}_oauth_state`,redirectUri:`quickslice_${t}_redirect_uri`}}function T(t){return{get(e){let r=t[e];return e==="codeVerifier"||e==="oauthState"||e==="redirectUri"?sessionStorage.getItem(r):localStorage.getItem(r)},set(e,r){let i=t[e];e==="codeVerifier"||e==="oauthState"||e==="redirectUri"?sessionStorage.setItem(i,r):localStorage.setItem(i,r)},remove(e){let r=t[e];sessionStorage.removeItem(r),localStorage.removeItem(r)},clear(){Object.keys(t).forEach(e=>{let r=t[e];sessionStorage.removeItem(r),localStorage.removeItem(r)})}}}function d(t){let e=t instanceof Uint8Array?t:new Uint8Array(t),r="";for(let i=0;i<e.length;i++)r+=String.fromCharCode(e[i]);return btoa(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function f(t){let e=new Uint8Array(t);return crypto.getRandomValues(e),d(e)}async function S(t){let e=new TextEncoder,r=await crypto.subtle.digest("SHA-256",e.encode(t));return d(r)}async function E(t){let e=new TextEncoder,r=await crypto.subtle.digest("SHA-256",e.encode(t));return Array.from(new Uint8Array(r)).map(o=>o.toString(16).padStart(2,"0")).join("").substring(0,8)}async function _(t,e,r){let i=new TextEncoder,n=d(i.encode(JSON.stringify(t))),o=d(i.encode(JSON.stringify(e))),s=`${n}.${o}`,c=await crypto.subtle.sign({name:"ECDSA",hash:"SHA-256"},r,i.encode(s)),a=d(c);return`${s}.${a}`}var Z=1,l="dpop-keys",D="dpop-key",A=new Map;function ee(t){return`quickslice-oauth-${t}`}function U(t){let e=A.get(t);if(e)return e;let r=new Promise((i,n)=>{let o=indexedDB.open(ee(t),Z);o.onerror=()=>n(o.error),o.onsuccess=()=>i(o.result),o.onupgradeneeded=s=>{let c=s.target.result;c.objectStoreNames.contains(l)||c.createObjectStore(l,{keyPath:"id"})}});return A.set(t,r),r}async function te(t){let e=await U(t);return new Promise((r,i)=>{let s=e.transaction(l,"readonly").objectStore(l).get(D);s.onerror=()=>i(s.error),s.onsuccess=()=>r(s.result||null)})}async function re(t,e,r){let i=await U(t);return new Promise((n,o)=>{let a=i.transaction(l,"readwrite").objectStore(l).put({id:D,privateKey:e,publicJwk:r,createdAt:Date.now()});a.onerror=()=>o(a.error),a.onsuccess=()=>n()})}async function y(t){let e=await te(t);if(e)return e;let r=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!1,["sign"]),i=await crypto.subtle.exportKey("jwk",r.publicKey);return await re(t,r.privateKey,i),{id:D,privateKey:r.privateKey,publicJwk:i,createdAt:Date.now()}}async function P(t,e,r,i=null){let n=await y(t),{kty:o,crv:s,x:c,y:a}=n.publicJwk,h={alg:"ES256",typ:"dpop+jwt",jwk:{kty:o,crv:s,x:c,y:a}},m={jti:f(16),htm:e,htu:r,iat:Math.floor(Date.now()/1e3)};return i&&(m.ath=await S(i)),await _(h,m,n.privateKey)}async function R(t){let e=await U(t);return new Promise((r,i)=>{let s=e.transaction(l,"readwrite").objectStore(l).clear();s.onerror=()=>i(s.error),s.onsuccess=()=>r()})}function $(){return f(32)}async function q(t){let r=new TextEncoder().encode(t),i=await crypto.subtle.digest("SHA-256",r);return d(i)}function Q(){return f(16)}async function J(t,e,r){let i=await y(e),n=await ie(i.publicJwk),o=await fetch(`${t}/api/client/session`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({clientId:r.clientId,dpopJkt:n,userDid:r.userDid,atpSessionId:r.atpSessionId})});if(!o.ok){let s=await o.json().catch(()=>({}));throw new Error(`Failed to create session: ${s.message||o.statusText}`)}return await o.json()}async function I(t){let e=await fetch(`${t}/api/client/session`,{method:"GET",credentials:"include"});return e.ok?await e.json():{authenticated:!1,did:null,handle:null}}async function L(t){await fetch(`${t}/api/client/session`,{method:"DELETE",credentials:"include"})}async function ie(t){let e=JSON.stringify({crv:t.crv,kty:t.kty,x:t.x,y:t.y});return await S(e)}async function j(t,e,r,i={}){let n=$(),o=await q(n),s=Q(),c=i.redirectUri||window.location.origin+window.location.pathname;t.set("codeVerifier",n),t.set("oauthState",s),t.set("clientId",r),t.set("redirectUri",c);let a=new URLSearchParams({client_id:r,redirect_uri:c,response_type:"code",code_challenge:o,code_challenge_method:"S256",state:s});i.handle&&a.set("login_hint",i.handle),i.scope&&a.set("scope",i.scope),window.location.href=`${e}?${a.toString()}`}async function B(t,e,r,i){let n=new URLSearchParams(window.location.search),o=n.get("code"),s=n.get("state"),c=n.get("error");if(c)throw new Error(`OAuth error: ${c} - ${n.get("error_description")||""}`);if(!o||!s)return null;let a=t.get("oauthState");if(s!==a)throw new Error("OAuth state mismatch - possible CSRF attack");let p=t.get("codeVerifier"),h=t.get("clientId"),m=t.get("redirectUri");if(!p||!h||!m)throw new Error("Missing OAuth session data");let N=await P(e,"POST",r),w=await fetch(r,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",DPoP:N},body:new URLSearchParams({grant_type:"authorization_code",code:o,redirect_uri:m,client_id:h,code_verifier:p})});if(!w.ok){let H=await w.json().catch(()=>({}));throw new Error(`Token exchange failed: ${H.error_description||w.statusText}`)}let O=await w.json(),z=await J(i,e,{clientId:h,userDid:O.sub,atpSessionId:O.session_id});return t.remove("codeVerifier"),t.remove("oauthState"),t.remove("redirectUri"),window.history.replaceState({},document.title,window.location.pathname),z}async function V(t,e,r,i={}){await L(r),t.clear(),await R(e),i.reload!==!1&&window.location.reload()}async function K(t,e,r,i={},n=!1,o){let s={"Content-Type":"application/json"};if(n){let p=await P(t,"POST",e);s.DPoP=p}let c=await fetch(e,{method:"POST",headers:s,body:JSON.stringify({query:r,variables:i}),credentials:"include",signal:o});if(!c.ok)throw new Error(`GraphQL request failed: ${c.statusText}`);let a=await c.json();if(a.errors&&a.errors.length>0)throw new Error(`GraphQL error: ${a.errors[0].message}`);return a.data}var u=class{constructor(e){this.initialized=!1;this.namespace="";this.storage=null;this.cachedSession=null;this.server=e.server.replace(/\/$/,""),this.clientId=e.clientId,this.redirectUri=e.redirectUri,this.scope=e.scope,this.graphqlUrl=`${this.server}/graphql`,this.authorizeUrl=`${this.server}/oauth/authorize`,this.tokenUrl=`${this.server}/oauth/token`}async init(){if(this.initialized)return;this.namespace=await E(this.clientId);let e=C(this.namespace);this.storage=T(e),await y(this.namespace),this.initialized=!0}getStorage(){if(!this.storage)throw new Error("Client not initialized. Call init() first.");return this.storage}async loginWithRedirect(e={}){await this.init(),await j(this.getStorage(),this.authorizeUrl,this.clientId,{...e,redirectUri:e.redirectUri||this.redirectUri,scope:e.scope||this.scope})}async handleRedirectCallback(){await this.init();let e=await B(this.getStorage(),this.namespace,this.tokenUrl,this.server);return e&&(this.cachedSession=e),e}async logout(e={}){await this.init(),this.cachedSession=null,await V(this.getStorage(),this.namespace,this.server,e)}async isAuthenticated(){await this.init();let e=await I(this.server);return this.cachedSession=e,e.authenticated}async getUser(){await this.init();let e=this.cachedSession;return e||(e=await I(this.server),this.cachedSession=e),!e.authenticated||!e.did?null:{did:e.did,handle:e.handle??void 0}}async query(e,r={},i={}){return await this.init(),await K(this.namespace,this.graphqlUrl,e,r,!0,i.signal)}async mutate(e,r={},i={}){return this.query(e,r,i)}async publicQuery(e,r={},i={}){return await this.init(),await K(this.namespace,this.graphqlUrl,e,r,!1,i.signal)}};var g=class extends Error{constructor(e){super(e),this.name="QuicksliceError"}},x=class extends g{constructor(e="Login required"){super(e),this.name="LoginRequiredError"}},b=class extends g{constructor(e){super(e),this.name="NetworkError"}},k=class extends g{constructor(e,r){super(`OAuth error: ${e}${r?` - ${r}`:""}`),this.name="OAuthError",this.code=e,this.description=r}};async function ne(t){let e=new u(t);return await e.init(),e}return X(oe);})();
